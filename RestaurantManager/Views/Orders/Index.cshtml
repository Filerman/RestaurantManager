@using RestaurantManager.Models
@model IEnumerable<RestaurantManager.Models.Order>
@{
    ViewData["Title"] = "System POS - Zamówienia";

    string activeTab = ViewBag.ActiveTab as string ?? "online";

    var onlineOrders = Model.Where(o => o.Type == OrderType.Delivery || o.Type == OrderType.Takeaway);
    var dineInOrders = Model.Where(o => o.Type == OrderType.DineIn);
}

<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Aktywne Zamówienia (POS)</h2>
        <div>
            <a asp-action="Archive" class="btn btn-outline-secondary btn-lg me-2"><i class="bi bi-archive"></i> Archiwum</a>
            <a asp-action="Tables" class="btn btn-primary btn-lg"><i class="bi bi-grid-3x3-gap"></i> Mapa Stolików (Nowe Zamówienie)</a>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="ordersTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "online" ? "active" : "")" id="online-tab" data-bs-toggle="tab" data-bs-target="#online" type="button" role="tab" aria-controls="online" aria-selected="@(activeTab == "online" ? "true" : "false")">
                Dostawa / Wynos <span class="badge bg-danger">@onlineOrders.Count()</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "dinein" ? "active" : "")" id="dinein-tab" data-bs-toggle="tab" data-bs-target="#dinein" type="button" role="tab" aria-controls="dinein" aria-selected="@(activeTab == "dinein" ? "true" : "false")">
                Sala (Stoliki) <span class="badge bg-info text-dark">@dineInOrders.Count()</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="ordersTabContent">
        <div class="tab-pane fade @(activeTab == "online" ? "show active" : "")" id="online" role="tabpanel" aria-labelledby="online-tab">
            <div class="row">
                @if (!onlineOrders.Any())
                {
                    <div class="col-12 text-muted">Brak aktywnych zamówień online.</div>
                }
                @foreach (var order in onlineOrders)
                {
                    var timeLeft = order.ScheduledDate - DateTime.Now;
                    var cardClass = timeLeft.TotalMinutes < 15 ? "border-danger" : (timeLeft.TotalMinutes < 60 ? "border-warning" : "border-info");
                    if (order.Status == OrderStatus.Ready) { cardClass = "border-success"; }

                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card @cardClass shadow h-100">
                            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                <strong>#@order.Id</strong>
                                <span class="badge bg-secondary">@order.Type</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">@order.ScheduledDate.ToString("HH:mm") <small class="text-muted">(@order.ScheduledDate.ToString("dd.MM"))</small></h5>
                                <p class="card-text mb-1"><strong>@order.CustomerName</strong></p>
                                <p class="card-text mb-2"><small>@order.CustomerPhone</small></p>

                                @if (!string.IsNullOrEmpty(order.DeliveryAddress))
                                {
                                    <div class="alert alert-light p-1 border mb-2 small"><i class="bi bi-truck"></i> @order.DeliveryAddress</div>
                                }
                                <hr class="my-2" />
                                <ul class="list-unstyled small mb-3">
                                    @foreach (var item in order.OrderItems)
                                    {
                                        <li><strong>@item.Quantity x</strong> @item.MenuItem.Name</li>
                                    }
                                </ul>
                                @if (!string.IsNullOrEmpty(order.Notes))
                                {
                                    <p class="text-danger small"><strong>Uwagi:</strong> @order.Notes</p>
                                }
                            </div>
                            <div class="card-footer bg-white text-center">
                                @await Html.PartialAsync("_OrderStatusButtons", order, new ViewDataDictionary(ViewData) { { "Tab", "online" } })
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="tab-pane fade @(activeTab == "dinein" ? "show active" : "")" id="dinein" role="tabpanel" aria-labelledby="dinein-tab">
            <div class="row">
                @if (!dineInOrders.Any())
                {
                    <div class="col-12 text-muted">Brak otwartych rachunków na sali.</div>
                }
                @foreach (var order in dineInOrders)
                {
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card border-primary shadow h-100">
                            <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                                <strong>@(order.Table != null ? order.Table.Name : "Stolik nieznany")</strong>
                                <span class="badge bg-light text-primary">#@order.Id</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title text-center">Kwota: @order.TotalAmount.ToString("C")</h5>
                                <hr class="my-2" />
                                <ul class="list-unstyled small mb-3">
                                    @foreach (var item in order.OrderItems)
                                    {
                                        if (item.IsServed)
                                        {
                                            <li class="text-decoration-line-through text-muted"><i class="bi bi-check-circle-fill text-success"></i> <strong>@item.Quantity x</strong> @item.MenuItem.Name</li>
                                        }
                                        else
                                        {
                                            <li><i class="bi bi-hourglass-split text-warning"></i> <strong>@item.Quantity x</strong> @item.MenuItem.Name</li>
                                        }
                                    }
                                </ul>
                                <div class="d-grid gap-2">
                                    <a asp-action="ManageTable" asp-route-id="@order.TableId" class="btn btn-outline-primary btn-sm">Edytuj / Dodaj</a>
                                </div>
                            </div>
                            <div class="card-footer bg-white text-center">
                                @await Html.PartialAsync("_OrderStatusButtons", order, new ViewDataDictionary(ViewData) { { "Tab", "dinein" } })
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>