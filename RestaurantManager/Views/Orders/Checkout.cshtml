@model RestaurantManager.ViewModels.OrderCheckoutViewModel
@{
    ViewData["Title"] = "Finalizacja Zamówienia";
    decimal cartTotal = Model.TotalAmount;

    // Pobieramy godziny z ViewBag
    var todayHours = ViewBag.TodayOpeningHours as RestaurantManager.Models.OpeningHour;
    int estimatedTime = ViewBag.EstimatedTime != null ? (int)ViewBag.EstimatedTime : 45;
}

<div class="container mt-4">
    <h2>Finalizacja Zamówienia</h2>
    <hr />

    <div class="row">
        <div class="col-md-7">
            @* DODANO method="post" dla pewności *@
            <form asp-action="Checkout" method="post">

                @* Wyświetlamy WSZYSTKIE błędy na górze *@
                <div asp-validation-summary="All" class="alert alert-danger" role="alert">
                    <strong>Wystąpiły błędy w formularzu:</strong>
                </div>

                @* INFO O GODZINACH OTWARCIA *@
                <div class="alert alert-info d-flex align-items-center">
                    <i class="bi bi-clock-history fs-4 me-3"></i>
                    <div>
                        @if (todayHours != null && !todayHours.IsClosed)
                        {
                            <span>
                                Dzisiaj jesteśmy otwarci: <strong>@todayHours.OpenTime.ToString(@"hh\:mm") - @todayHours.CloseTime.ToString(@"hh\:mm")</strong>.<br />
                                Średni czas oczekiwania na dostawę: <strong>ok. @estimatedTime min</strong>.
                            </span>
                        }
                        else
                        {
                            <span class="text-danger fw-bold">Dzisiaj restauracja jest nieczynna.</span>
                        }
                    </div>
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-light fw-bold">Dane Kontaktowe</div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label asp-for="CustomerName" class="form-label"></label>
                            <input asp-for="CustomerName" class="form-control" placeholder="Wpisz imię i nazwisko" />
                            <span asp-validation-for="CustomerName" class="text-danger"></span>
                        </div>
                        <div class="row">
                            <div class="col-md-6 form-group mb-3">
                                <label asp-for="CustomerPhone" class="form-label"></label>
                                <input asp-for="CustomerPhone" class="form-control" />
                                <span asp-validation-for="CustomerPhone" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 form-group mb-3">
                                <label asp-for="CustomerEmail" class="form-label"></label>
                                <input asp-for="CustomerEmail" class="form-control" />
                                <span asp-validation-for="CustomerEmail" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-light fw-bold">Realizacja</div>
                    <div class="card-body">

                        <div class="mb-4">
                            <label class="form-label fw-bold d-block">Kiedy?</label>

                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" asp-for="IsAsap" value="true" id="timeAsap" onchange="toggleTimeInput()">
                                <label class="form-check-label" for="timeAsap">
                                    <i class="bi bi-lightning-fill text-warning"></i> Jak najszybciej (ok. @estimatedTime min)
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" asp-for="IsAsap" value="false" id="timeScheduled" onchange="toggleTimeInput()">
                                <label class="form-check-label" for="timeScheduled">
                                    <i class="bi bi-calendar-event"></i> Zaplanuj na później
                                </label>
                            </div>
                        </div>

                        <div class="form-group mb-4" id="scheduledTimeGroup" style="display:none;">
                            <label asp-for="ScheduledDate" class="form-label fw-bold text-primary">Wybierz godzinę:</label>
                            @* Atrybut min blokuje daty przeszłe w kalendarzu *@
                            <input asp-for="ScheduledDate" class="form-control" type="datetime-local"
                                   value="@Model.ScheduledDate.ToString("yyyy-MM-ddTHH:mm")"
                                   min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                            <div class="form-text">System nie pozwoli złożyć zamówienia poza godzinami otwarcia.</div>
                            <span asp-validation-for="ScheduledDate" class="text-danger"></span>
                        </div>

                        <hr class="my-4" />

                        <div class="form-group mb-4">
                            <label asp-for="OrderType" class="form-label fw-bold">Sposób odbioru:</label>
                            <select asp-for="OrderType" class="form-select" id="orderTypeSelect" asp-items="Html.GetEnumSelectList<RestaurantManager.Models.OrderType>()" onchange="toggleAddressFields()">
                            </select>
                            <span asp-validation-for="OrderType" class="text-danger"></span>
                        </div>

                        <div id="addressFields" style="display:none;">
                            <h6 class="text-muted mb-3">Adres dostawy:</h6>
                            <div class="form-group mb-3">
                                <label asp-for="DeliveryStreet" class="form-label"></label>
                                <input asp-for="DeliveryStreet" class="form-control" placeholder="Ulica i numer" />
                                <span asp-validation-for="DeliveryStreet" class="text-danger"></span>
                            </div>
                            <div class="row">
                                <div class="col-md-4 form-group mb-3">
                                    <label asp-for="DeliveryZipCode" class="form-label"></label>
                                    <input asp-for="DeliveryZipCode" class="form-control" placeholder="XX-XXX" />
                                    <span asp-validation-for="DeliveryZipCode" class="text-danger"></span>
                                </div>
                                <div class="col-md-8 form-group mb-3">
                                    <label asp-for="DeliveryCity" class="form-label fw-bold text-primary">Miejscowość:</label>
                                    <select asp-for="DeliveryCity" class="form-select" id="citySelect" asp-items="ViewBag.CityList" onchange="updateTotal()">
                                    </select>
                                    <span asp-validation-for="DeliveryCity" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-2">
                            <label asp-for="Notes" class="form-label">Uwagi (opcjonalne)</label>
                            <textarea asp-for="Notes" class="form-control" rows="2" placeholder="Np. kod do domofonu..."></textarea>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success btn-lg w-100 py-3">
                    Zamawiam i Płacę (<span id="totalButtonAmount">@cartTotal.ToString("F2")</span> zł)
                </button>
            </form>
        </div>

        <div class="col-md-5">
            <div class="card bg-light border-0 sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h4 class="card-title">Podsumowanie</h4>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Koszyk:</span>
                        <span>@cartTotal.ToString("F2") zł</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-muted" id="deliveryRow" style="display:none;">
                        <span>Dostawa:</span>
                        <span id="deliveryCostDisplay">0,00 zł</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>Razem:</strong>
                        <h2 class="text-primary mb-0"><span id="totalDisplay">@cartTotal.ToString("F2")</span> zł</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Pobieramy dane o opłatach z ViewBag (bezpiecznie sformatowane jako JSON)
    var cityFees = @Html.Raw(ViewBag.CityFeesJson ?? "{}");
    // Używamy InvariantCulture dla liczb w JS (kropka zamiast przecinka)
    var baseTotal = @cartTotal.ToString(System.Globalization.CultureInfo.InvariantCulture);

    function toggleTimeInput() {
        var isScheduled = document.getElementById('timeScheduled').checked;
        var timeGroup = document.getElementById('scheduledTimeGroup');
        if (isScheduled) {
            timeGroup.style.display = 'block';
        } else {
            timeGroup.style.display = 'none';
        }
    }

    function toggleAddressFields() {
        var select = document.getElementById('orderTypeSelect');
        var addressDiv = document.getElementById('addressFields');
        var deliveryRow = document.getElementById('deliveryRow');

        // Sprawdzamy wartość enum. Zazwyczaj Delivery = 0.
        // Upewnij się w HTML (zbadaj element), czy value="0" to Dostawa.
        var isDelivery = (select.value == '0');

        if (isDelivery) {
            addressDiv.style.display = 'block';
            deliveryRow.style.display = 'flex';
        } else {
            addressDiv.style.display = 'none';
            deliveryRow.style.display = 'none';
        }
        updateTotal();
    }

    function updateTotal() {
        var select = document.getElementById('orderTypeSelect');
        var citySelect = document.getElementById('citySelect');

        var deliveryFee = 0;
        var isDelivery = (select.value == '0');

        if (isDelivery && citySelect) {
            var selectedCity = citySelect.value;
            if (cityFees[selectedCity] !== undefined) {
                deliveryFee = cityFees[selectedCity];
            }
        }

        var finalTotal = baseTotal + deliveryFee;

        // Wyświetlanie (z przecinkiem dla polskiego oka)
        document.getElementById('deliveryCostDisplay').innerText = deliveryFee.toFixed(2).replace('.', ',') + " zł";

        var formattedTotal = finalTotal.toFixed(2).replace('.', ',');
        document.getElementById('totalDisplay').innerText = formattedTotal;
        document.getElementById('totalButtonAmount').innerText = formattedTotal;
    }

    document.addEventListener("DOMContentLoaded", function() {
        toggleTimeInput();
        toggleAddressFields();
    });
</script>