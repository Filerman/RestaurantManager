@model IEnumerable<RestaurantManager.Models.FaqItem>
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "FAQ";
    var userId = HttpContextAccessor.HttpContext.Session.GetInt32("UserId");
    var isLogged = userId.HasValue;

    // Pobieramy flagę z ViewBag ustawioną w kontrolerze
    var isStaff = ViewBag.IsStaff as bool? ?? false;
    var currentFilter = ViewBag.CurrentFilter as string;
}

<div class="container mt-4">

    @* --- NAGŁÓWEK I FILTROWANIE (TYLKO DLA PERSONELU) --- *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Często Zadawane Pytania (FAQ)</h2>

        @if (isStaff)
        {
            <form method="get" asp-action="Index" class="d-flex align-items-center">
                <label class="me-2 fw-bold small text-muted">Filtruj:</label>
                <select name="filter" class="form-select form-select-sm" onchange="this.form.submit()" style="width:auto;">
                    <!option value="all" @(currentFilter == "all" ? "selected" : "")>Wszystkie</!option>
                    <!option value="public" @(currentFilter == "public" ? "selected" : "")>Dla Klientów</!option>
                    <!option value="internal" @(currentFilter == "internal" ? "selected" : "")>Dla Personelu</!option>
                </select>
            </form>
        }
    </div>

    @* --- Lista pytań (Akordeon) --- *@
    <div class="accordion mb-5" id="faqAccordion">
        @if (!Model.Any())
        {
            <div class="alert alert-info text-center">Brak pytań w bazie wiedzy dla wybranych kryteriów.</div>
        }
        else
        {
            foreach (var item in Model.Select((value, index) => new { value, index }))
            {
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-@item.index">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@item.index" aria-expanded="false" aria-controls="collapse-@item.index">
                            @item.value.Question

                            @* Oznaczenie dla personelu *@
                            @if (!item.value.IsPublic)
                            {
                                <span class="badge bg-warning text-dark ms-2">
                                    <i class="bi bi-shield-lock"></i> Tylko personel
                                </span>
                            }
                        </button>
                    </h2>
                    <div id="collapse-@item.index" class="accordion-collapse collapse" aria-labelledby="heading-@item.index" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            @item.value.Answer
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    @* --- Sekcja: Zadaj Pytanie --- *@
    <div class="card text-center shadow-sm mb-5">
        <div class="card-body py-4">
            <h4 class="card-title">Nie znalazłeś odpowiedzi?</h4>
            <p class="card-text text-muted">Skontaktuj się bezpośrednio z naszym managerem.</p>

            @if (isLogged)
            {
                @* Widok dla ZALOGOWANEGO (Klienta lub Pracownika) *@
                <a asp-controller="Support" asp-action="Create" class="btn btn-primary btn-lg">
                    <i class="bi bi-chat-right-text-fill me-2"></i>Zadaj pytanie Managerowi
                </a>
                <div class="mt-2">
                    <a asp-controller="Support" asp-action="MyTickets" class="text-decoration-none small">
                        Zobacz status swoich pytań
                    </a>
                </div>
            }
            else
            {
                @* Widok dla NIEZALOGOWANEGO (Gościa) *@
                <div class="alert alert-warning d-inline-block mb-0">
                    <i class="bi bi-lock-fill me-2"></i>
                    <a asp-controller="Auth" asp-action="Login" class="alert-link">Zaloguj się</a>, aby zadać pytanie indywidualne.
                </div>
            }
        </div>
    </div>
</div>