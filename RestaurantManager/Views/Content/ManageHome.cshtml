@model RestaurantManager.ViewModels.HomeContentViewModel
@{
    ViewData["Title"] = "Edycja Strony Głównej";
    double aspectRatio = 4.0 / 3.0;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

<div class="container mt-4 mb-5 pb-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-0">Strona Główna</h2>
            <p class="text-muted small mb-0">Zarządzaj treścią widoczną dla klientów</p>
        </div>
    </div>

    <form asp-action="ManageHome" enctype="multipart/form-data" method="post" id="mainForm">
        <input type="hidden" asp-for="Id" />

        <div class="row g-4">

            <div class="col-lg-6">
                <div class="card shadow-sm border-0 rounded-4 h-100">
                    <div class="card-header bg-white py-3 border-bottom-0">
                        <h5 class="fw-bold text-primary mb-0"><i class="bi bi-fonts me-2"></i>Teksty Powitalne</h5>
                    </div>
                    <div class="card-body p-4 bg-light bg-opacity-25">
                        <div class="mb-4">
                            <label asp-for="HeroTitle" class="form-label fw-bold small text-uppercase text-muted ls-1">Nagłówek główny</label>
                            <input asp-for="HeroTitle" class="form-control rounded-3 form-control-lg" placeholder="Np. Witamy w naszej restauracji" />
                            <span asp-validation-for="HeroTitle" class="text-danger small"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="HeroSubtitle" class="form-label fw-bold small text-uppercase text-muted ls-1">Podtytuł</label>
                            <textarea asp-for="HeroSubtitle" class="form-control rounded-3" rows="4" placeholder="Krótki opis zachęcający klientów..."></textarea>
                            <span asp-validation-for="HeroSubtitle" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm border-0 rounded-4 h-100">
                    <div class="card-header bg-white py-3 border-bottom-0">
                        <h5 class="fw-bold text-success mb-0"><i class="bi bi-images me-2"></i>Karuzela Zdjęć</h5>
                    </div>
                    <div class="card-body p-4 bg-light bg-opacity-25">
                        <div class="alert alert-info border-0 shadow-sm rounded-3 d-flex align-items-center mb-4">
                            <i class="bi bi-info-circle-fill fs-4 me-3 text-info"></i>
                            <div class="small">
                                <strong>Format 4:3</strong><br />
                                Po wybraniu pliku otworzy się okno kadrowania, aby zapewnić spójny wygląd karuzeli.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="NewImages" class="form-label fw-bold small text-uppercase text-muted ls-1">Dodaj nowe zdjęcie</label>
                            <div class="input-group">
                                <input asp-for="NewImages" type="file" class="form-control rounded-3" accept="image/*" id="imageInput" />
                            </div>
                            <div class="form-text mt-2" id="uploadHelp">Obsługiwane formaty: JPG, PNG.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed-bottom bg-white border-top py-3 shadow-lg" style="z-index: 1000;">
            <div class="container d-flex justify-content-end gap-2">
                <a asp-controller="Home" asp-action="Index" class="btn btn-light border rounded-pill px-4 fw-medium">Anuluj</a>
                <button type="submit" class="btn btn-success rounded-pill px-5 fw-bold shadow-sm" id="submitBtn">
                    <i class="bi bi-save me-2"></i> Zapisz Zmiany
                </button>
            </div>
        </div>
    </form>

    <div class="mt-5">
        <h5 class="fw-bold text-dark mb-4">Zarządzaj aktywnymi zdjęciami</h5>

        @if (Model.ExistingImages != null && Model.ExistingImages.Any())
        {
            <div class="row g-4">
                @foreach (var img in Model.ExistingImages)
                {
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden group-hover-btn position-relative">
                            <div class="ratio ratio-4x3">
                                <img src="@img.ImagePath" class="card-img-top object-fit-cover" alt="Zdjęcie z karuzeli">
                            </div>
                            <form asp-action="DeleteImage" method="post" class="position-absolute bottom-0 w-100 p-2" style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                                <input type="hidden" name="id" value="@img.Id" />
                                <button type="submit" class="btn btn-danger btn-sm w-100 rounded-pill fw-bold shadow-sm" onclick="return confirm('Na pewno usunąć to zdjęcie?');">
                                    <i class="bi bi-trash-fill me-1"></i> Usuń
                                </button>
                            </form>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-secondary border-0 rounded-4 py-4 text-center">
                <i class="bi bi-images fs-1 text-muted opacity-50 mb-2 d-block"></i>
                <span class="text-muted">Brak zdjęć w karuzeli. Strona główna wyświetla domyślną grafikę.</span>
            </div>
        }
    </div>

    <div style="height: 80px;"></div>
</div>

<div class="modal fade" id="cropModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 overflow-hidden">
            <div class="modal-header bg-dark text-white border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-crop me-2"></i>Dopasuj zdjęcie (4:3)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="resetInput()"></button>
            </div>
            <div class="modal-body p-0 bg-black d-flex align-items-center justify-content-center" style="height: 60vh;">
                <img id="imageToCrop" src="" alt="Picture to crop" style="display: block; max-width: 100%; max-height: 100%;">
            </div>
            <div class="modal-footer bg-dark border-0">
                <button type="button" class="btn btn-outline-light rounded-pill px-4" data-bs-dismiss="modal" onclick="resetInput()">Anuluj</button>
                <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" id="cropAndSaveBtn">
                    <i class="bi bi-check-lg me-2"></i>Zatwierdź
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        let cropper;
        const imageInput = document.getElementById('imageInput');
        const imageToCrop = document.getElementById('imageToCrop');
        const cropModalElement = document.getElementById('cropModal');
        const cropModal = new bootstrap.Modal(cropModalElement);
        const cropAndSaveBtn = document.getElementById('cropAndSaveBtn');
        const uploadHelp = document.getElementById('uploadHelp');

        function resetInput() {
            imageInput.value = '';
            uploadHelp.textContent = "Obsługiwane formaty: JPG, PNG.";
            uploadHelp.className = "form-text mt-2";
        }

        imageInput.addEventListener('change', function (e) {
            const files = e.target.files;
            if (files && files.length > 0 && files[0].type.startsWith('image/')) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = function (event) {
                    imageToCrop.src = event.target.result;
                    cropModal.show();
                };
                reader.readAsDataURL(file);
            }
        });

        cropModalElement.addEventListener('shown.bs.modal', function () {
            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(imageToCrop, {
                aspectRatio: @(aspectRatio.ToString(System.Globalization.CultureInfo.InvariantCulture)),
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.9,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                background: false
            });
        });

        cropAndSaveBtn.addEventListener('click', function () {
            if (!cropper) return;
            cropper.getCroppedCanvas({
                width: 1200,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            }).toBlob((blob) => {
                const fileName = imageInput.files[0].name;
                const croppedFile = new File([blob], fileName, { type: blob.type });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(croppedFile);
                imageInput.files = dataTransfer.files;

                uploadHelp.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> Zdjęcie wykadrowane i gotowe do zapisu.';
                uploadHelp.className = "form-text mt-2 text-success fw-bold";
                cropModal.hide();
            }, 'image/jpeg', 0.9);
        });
    </script>
}