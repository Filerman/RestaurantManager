@model IEnumerable<RestaurantManager.Models.Shift>

@{
    ViewData["Title"] = "Mój Grafik";

    int currentYear = ViewBag.CurrentYear;
    int currentMonth = ViewBag.CurrentMonth;
    var monthDate = new DateTime(currentYear, currentMonth, 1);
    string monthLabel = monthDate.ToString("MMMM yyyy", new System.Globalization.CultureInfo("pl-PL"));
    monthLabel = char.ToUpper(monthLabel[0]) + monthLabel.Substring(1);

    string viewType = ViewBag.ViewType as string ?? "calendar";

    string GetRoute(int y, int m) => Url.Action("MySchedule", new { year = y, month = m, viewType = viewType });
}

<div class="container mt-4 mb-5">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 p-3 bg-white rounded-4 shadow-sm border">
        <h2 class="mb-2 mb-md-0 text-dark fw-bold h4"><i class="bi bi-calendar-check me-2 text-primary"></i>Mój Grafik</h2>

        <div class="d-flex gap-3 align-items-center">
            <div class="btn-group shadow-sm rounded-pill overflow-hidden" role="group">
                <a asp-action="MySchedule" asp-route-year="@currentYear" asp-route-month="@currentMonth" asp-route-viewType="calendar"
                   class="btn btn-outline-primary border-0 @(viewType == "calendar" ? "active fw-bold" : "")">
                    <i class="bi bi-grid-3x3 me-1"></i> Kalendarz
                </a>
                <a asp-action="MySchedule" asp-route-year="@currentYear" asp-route-month="@currentMonth" asp-route-viewType="list"
                   class="btn btn-outline-primary border-0 @(viewType == "list" ? "active fw-bold" : "")">
                    <i class="bi bi-list-ul me-1"></i> Lista
                </a>
            </div>

            <div class="btn-group shadow-sm rounded-pill overflow-hidden" role="group">
                <a href="@GetRoute(currentMonth == 1 ? currentYear - 1 : currentYear, currentMonth == 1 ? 12 : currentMonth - 1)"
                   class="btn btn-light border-0 text-muted hover-dark">
                    <i class="bi bi-chevron-left"></i>
                </a>

                <button type="button" class="btn btn-light border-0 px-4 fw-bold text-dark" style="min-width: 180px;" disabled>
                    @monthLabel
                </button>

                <a href="@GetRoute(currentMonth == 12 ? currentYear + 1 : currentYear, currentMonth == 12 ? 1 : currentMonth + 1)"
                   class="btn btn-light border-0 text-muted hover-dark">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>

    @if (viewType == "list")
    {
        <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
            <div class="card-body p-0">
                @if (!Model.Any())
                {
                    <div class="p-5 text-center text-muted">
                        <i class="bi bi-calendar-x fs-1 d-block mb-3 opacity-25"></i>
                        Brak zmian w tym miesiącu.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light small text-uppercase text-muted">
                                <tr>
                                    <th class="ps-4 py-3">Dzień</th>
                                    <th>Data</th>
                                    <th>Stanowisko</th>
                                    <th>Godziny</th>
                                    <th class="pe-4 text-end">Czas</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var shift in Model.OrderBy(s => s.Date).ThenBy(s => s.StartTime))
                                {
                                    var duration = (shift.EndTime - shift.StartTime).TotalHours;
                                    var isToday = shift.Date.Date == DateTime.Today;
                                    <tr class="@(isToday ? "bg-primary bg-opacity-10" : "") border-bottom-0">
                                        <td class="ps-4">@shift.Date.ToString("dddd", new System.Globalization.CultureInfo("pl-PL"))</td>
                                        <td class="fw-bold">@shift.Date.ToString("dd.MM.yyyy")</td>
                                        <td>
                                            @if (shift.ShiftPositionTag != null)
                                            {
                                                <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary rounded-pill fw-normal">@shift.ShiftPositionTag.Name</span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                        <td>
                                            <i class="bi bi-clock me-1 text-muted"></i>
                                            @shift.StartTime.ToString(@"hh\:mm") - @shift.EndTime.ToString(@"hh\:mm")
                                        </td>
                                        <td class="pe-4 text-end fw-bold text-primary">@duration.ToString("F1") h</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        var firstDayOfMonth = new DateTime(currentYear, currentMonth, 1);
        var daysInMonth = DateTime.DaysInMonth(currentYear, currentMonth);
        int offset = ((int)firstDayOfMonth.DayOfWeek + 6) % 7;

        <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
            <div class="card-body p-0">
                <div class="calendar-header bg-light text-muted small text-uppercase fw-bold border-bottom">
                    <div>Pn</div><div>Wt</div><div>Śr</div><div>Cz</div><div>Pt</div><div class="text-danger">Sb</div><div class="text-danger">Nd</div>
                </div>

                <div class="calendar-grid">
                    @for (int i = 0; i < offset; i++)
                    {
                        <div class="calendar-day empty bg-light bg-opacity-25"></div>
                    }

                    @for (int day = 1; day <= daysInMonth; day++)
                    {
                        var currentDate = new DateTime(currentYear, currentMonth, day);
                        var isToday = currentDate == DateTime.Today;
                        var shiftsToday = Model.Where(s => s.Date.Day == day).OrderBy(s => s.StartTime).ToList();

                        <div class="calendar-day @(isToday ? "today" : "")">
                            <div class="day-number @(isToday ? "text-primary fw-bold" : "text-muted")">@day</div>

                            <div class="d-flex flex-column gap-1">
                                @foreach (var shift in shiftsToday)
                                {
                                    <div class="shift-item p-1 rounded-2 bg-primary bg-opacity-10 border border-primary text-primary" title="@shift.StartTime.ToString(@"hh\:mm") - @shift.EndTime.ToString(@"hh\:mm")">
                                        <div class="d-flex justify-content-between align-items-center" style="line-height: 1;">
                                            <small class="fw-bold" style="font-size: 0.7rem;">@shift.StartTime.ToString(@"hh\:mm")</small>
                                            <small style="font-size: 0.7rem;">@((shift.EndTime - shift.StartTime).TotalHours.ToString("0.#"))h</small>
                                        </div>
                                        @if (shift.ShiftPositionTag != null)
                                        {
                                            <div class="text-truncate mt-1 text-dark" style="font-size: 0.65rem;">@shift.ShiftPositionTag.Name</div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<style>
    .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        padding: 10px 0;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
    }

    .calendar-day {
        border-right: 1px solid #f0f0f0;
        border-bottom: 1px solid #f0f0f0;
        min-height: 120px;
        padding: 8px;
        position: relative;
        background-color: #fff;
    }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day.today {
            background-color: #f8faff;
            box-shadow: inset 0 0 0 2px var(--bs-primary);
        }

    .day-number {
        text-align: right;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    @@media (max-width: 768px) {
        .calendar-day {
            min-height: 80px;
            font-size: 0.8rem;
            padding: 4px;
        }

        .btn-group span {
            display: none;
        }
    }
</style>